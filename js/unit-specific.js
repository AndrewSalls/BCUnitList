import{checkPort,REQUEST_TYPES}from"./communication/iframe-link.js";import{getValuesFromRow,observeRowChange}from"./helper/link-row.js";import makeSearchable,{createSearchDropdown,initializeDataset}from"./helper/make-searchable.js";import*as RowComponents from"./unit-table/creation/create-unit-row.js";import createOrbMenu from"./unit-table/orb/create-orb-selector.js";import{initializeOrbSelection}from"./unit-table/orb/orb-selection.js";import SETTINGS from"../assets/settings.js";import createStatRow from"./unit-table/creation/create-stat-row.js";import createSearchModal,{openSearchModal}from"./unit-table/creation/create-search-modal.js";const RARITY_MAP={N:"normal",EX:"special",RR:"rare",SR:"super-rare",UR:"uber-rare",LR:"legend-rare"};function initialize(){const datalist=createSearchDropdown(),searchBox=document.querySelector("#search-box");document.body.appendChild(createSearchModal()),document.body.appendChild(datalist),REQUEST_TYPES.GET_NAMES().then(names=>initializeDataset(datalist,names)),makeSearchable(searchBox,id=>{loadSpecific(id)}),document.querySelector("#search-extra").onclick=()=>openSearchModal(u=>loadSpecific(u.id));let target=window.localStorage.getItem("su");target&&!Number.isNaN(target)||(target="0"),loadSpecific(parseInt(target))}document.addEventListener("DOMContentLoaded",()=>{document.body.appendChild(createOrbMenu()),initializeOrbSelection(),document.querySelector("#ut-uf-input").oninput=()=>{document.querySelectorAll(".evo-mat-needed").forEach(p=>{const temp=p.dataset.alt;p.dataset.alt=p.textContent??"",p.textContent=temp??null})},window.addEventListener("portLoaded",initialize),checkPort()&&window.dispatchEvent(new CustomEvent("portLoaded"))});let loadedObj=null,loadedLink=null;function loadSpecific(id){loadedLink&&loadedLink(),loadedObj&&loadedObj.remove();const container=document.querySelector("#loading-content");REQUEST_TYPES.GET_ID_DATA(id,!0).then(entry=>{if(!entry)return void console.error(`Missing unit data: ${id}`);window.localStorage.setItem("su",`${id}`);const wrapper=document.querySelector("#unit-border");wrapper.className=RARITY_MAP[entry.rarity]+"-color";const idBox=RowComponents.createIDBox(entry.id);wrapper.querySelector("#id-wrapper")?.replaceChildren(idBox);const[nameBox,nameUpdate]=RowComponents.createNameBox([entry.normal_form,entry.evolved_form,entry.true_form,entry.ultra_form],entry.current_form);wrapper.querySelector("#name-wrapper")?.replaceChildren(nameBox);const iconBox=RowComponents.createIconBox(entry.id,entry.current_form,entry.max_form,SETTINGS.skipImages.includes(id),nameUpdate);wrapper.querySelector("#icon-wrapper")?.replaceChildren(iconBox);const levelBox=RowComponents.createLevelBox(entry.id,entry.level_cap,entry.level,entry.plus_level);wrapper.querySelector("#level-wrapper")?.replaceChildren(levelBox);const talentBox=RowComponents.createTalentBox(entry.talents,entry.ultra_talents),talentWrapper=wrapper.querySelector("#talent-wrapper");if(talentWrapper?.replaceChildren(talentBox),0===entry.talents.length&&0===entry.ultra_talents.length){const noTalent=document.createElement("h4");noTalent.textContent="No Talents",talentWrapper?.replaceChildren(noTalent)}const orbBox=RowComponents.createOrbBox(entry.orb),orbWrapper=wrapper.querySelector("#orb-wrapper");if(orbWrapper?.replaceChildren(orbBox),0===entry.talents.length&&0===entry.ultra_talents.length){const noOrb=document.createElement("h4");noOrb.textContent="No Talent Orbs",orbWrapper?.replaceChildren(noOrb)}const favoriteBox=RowComponents.createFavoriteBox(entry.favorited);wrapper.querySelector("#favorite-wrapper")?.replaceChildren(favoriteBox),document.querySelector("#ut-uf-checkbox")?.classList.toggle("hidden","UR"!==entry.rarity),document.querySelector("#rarity-wrapper").textContent=parseKebabCase(RARITY_MAP[entry.rarity]),document.querySelector("#catseye-wrapper")?.classList.toggle("hidden","N"===entry.rarity),"N"!==entry.rarity&&(document.querySelector("#catseye-img").src=`./assets/img/evo_mats/${RARITY_MAP[entry.rarity].replace("-","_")}_catseye.png`),document.querySelector("#dark-wrapper")?.classList.toggle("hidden","UR"!==entry.rarity);const borderWrapper=document.querySelector("#unit-border");REQUEST_TYPES.GET_ID_COST(id,!0).then(cost=>{setSpecificCost(cost,entry.rarity),document.querySelector("#ut-uf-input").checked=!0,observeRowChange(borderWrapper,()=>{(async()=>{await REQUEST_TYPES.UPDATE_ID(getValuesFromRow(borderWrapper)),setSpecificCost(await REQUEST_TYPES.GET_ID_COST(id),entry.rarity)})()}),container?.classList.remove("hidden")});const{row:statBox,callback:deloadCallback}=createStatRow(entry,borderWrapper);loadedLink=deloadCallback;const rowContents=statBox.querySelector(".unit-stat-table");loadedObj=rowContents,rowContents.classList.add("specific-unit-stats"),wrapper.appendChild(rowContents)})}function setSpecificCost(cost,rarity){setupCostValue("xp-evo",cost.formXP,cost.ultra.formXP),setupCostValue("xp-30",cost.lvl30XP,cost.ultra.lvl30XP),setupCostValue("xp-max",cost.lvlMaxXP,cost.ultra.lvlMaxXP),setupCostValue("np",cost.maxNP,cost.ultra.maxNP),"N"!==rarity&&setupCostValue("catseye",cost[`catseye_${rarity}`],cost.ultra[`catseye_${rarity}`]),"UR"===rarity&&setupCostValue("dark-catseye",cost.catseye_dark,cost.ultra.catseye_dark),setupCostValue("green-fruit",cost.green_fruit,cost.ultra.green_fruit),setupCostValue("purple-fruit",cost.purple_fruit,cost.ultra.purple_fruit),setupCostValue("red-fruit",cost.red_fruit,cost.ultra.red_fruit),setupCostValue("blue-fruit",cost.blue_fruit,cost.ultra.blue_fruit),setupCostValue("yellow-fruit",cost.yellow_fruit,cost.ultra.yellow_fruit),setupCostValue("epic-fruit",cost.epic_fruit,cost.ultra.epic_fruit),setupCostValue("elder-fruit",cost.elder_fruit,cost.ultra.elder_fruit),setupCostValue("aku-fruit",cost.aku_fruit,cost.ultra.aku_fruit),setupCostValue("gold-fruit",cost.gold_fruit,cost.ultra.gold_fruit),setupCostValue("green-seed",cost.green_seed,cost.ultra.green_seed),setupCostValue("purple-seed",cost.purple_seed,cost.ultra.purple_seed),setupCostValue("red-seed",cost.red_seed,cost.ultra.red_seed),setupCostValue("blue-seed",cost.blue_seed,cost.ultra.blue_seed),setupCostValue("yellow-seed",cost.yellow_seed,cost.ultra.yellow_seed),setupCostValue("epic-seed",cost.epic_seed,cost.ultra.epic_seed),setupCostValue("elder-seed",cost.elder_seed,cost.ultra.elder_seed),setupCostValue("aku-seed",cost.aku_seed,cost.ultra.aku_seed),setupCostValue("gold-seed",cost.gold_seed,cost.ultra.gold_seed),setupCostValue("green-gem",cost.green_gem,cost.ultra.green_gem),setupCostValue("purple-gem",cost.purple_gem,cost.ultra.purple_gem),setupCostValue("red-gem",cost.red_gem,cost.ultra.red_gem),setupCostValue("blue-gem",cost.blue_gem,cost.ultra.blue_gem),setupCostValue("yellow-gem",cost.yellow_gem,cost.ultra.yellow_gem),setupCostValue("green-stone",cost.green_stone,cost.ultra.green_stone),setupCostValue("purple-stone",cost.purple_stone,cost.ultra.purple_stone),setupCostValue("red-stone",cost.red_stone,cost.ultra.red_stone),setupCostValue("blue-stone",cost.blue_stone,cost.ultra.blue_stone),setupCostValue("yellow-stone",cost.yellow_stone,cost.ultra.yellow_stone),setupCostValue("epic-stone",cost.epic_stone,cost.ultra.epic_stone)}function setupCostValue(target,value,ultraValue=null){const text=document.querySelector(`#${target}`);text.textContent=value.toLocaleString(),text.dataset.alt=(value-(ultraValue??0)).toLocaleString()}function parseKebabCase(str){return str.replaceAll(/\-[a-z]/g,m=>` ${m[1].toUpperCase()}`).replace(/^[a-z]/,m=>m[0].toUpperCase())}