import{createSearchDropdown,initializeDataset}from"./helper/make-searchable.js";import{encodeLink}from"./helper/encoder.js";import{createMinimalLoadout}from"./unit-table/creation/create-loadout-table.js";import{checkPort,REQUEST_TYPES}from"./communication/iframe-link.js";import SETTINGS from"../assets/settings.js";import createSearchModal from"./unit-table/creation/create-search-modal.js";let unlockedCannons=[];function initializeContent(){const addButton=document.querySelector("#add-loadout"),addTo=document.querySelector("#loadout-container");addButton.onclick=()=>{addTo.appendChild(createLoadout(null))};document.querySelector("#toggle-display-mode").onclick=()=>{const state=document.body.classList.toggle("disabled-editing-mode");document.querySelectorAll(".loadout-name").forEach(n=>n.disabled=state),window.localStorage.setItem("tdm",state?"1":"0")};document.querySelector("#query-display-loadout").onclick=()=>window.location.href="./loadout-display.html",document.body.appendChild(createSearchModal())}async function loadLoadouts(){const cannonTypeCount=SETTINGS.ototo.names.length;for(let x=2;x<=cannonTypeCount;x++){const cannonValues=window.localStorage.getItem(`oo_${x}`)?.split("-")??["0","0","0"];unlockedCannons[x-1]={cannon:parseInt(cannonValues[0])>0,style:parseInt(cannonValues[1])>0,foundation:parseInt(cannonValues[2])>0}}unlockedCannons[0]={cannon:!0,style:!0,foundation:!0};const datalist=createSearchDropdown();document.body.appendChild(datalist),await initializeDataset(datalist,await REQUEST_TYPES.GET_OWNED_FORM_NAMES(!0));const res=await REQUEST_TYPES.GET_ALL_LOADOUT(),wrapper=document.querySelector("#loadout-container");for(const loadout of res)wrapper?.appendChild(createLoadout(loadout));"1"===window.localStorage.getItem("tdm")&&document.querySelector("#toggle-display-mode").click()}function createLoadout(loadoutData){let minimalLoadout=null;const requestSave=()=>{const loadoutUnits=[...minimalLoadout.querySelectorAll(".chip.set-unit")].map(c=>parseInt(c.dataset.id)),position=Array.prototype.indexOf.call(document.querySelectorAll(".loadout-wrapper"),minimalLoadout);loadoutUnits.length>0?(minimalLoadout.classList.add("save"),REQUEST_TYPES.MODIFY_LOADOUT(position,createLoadoutObject(minimalLoadout))):minimalLoadout.classList.contains("save")&&REQUEST_TYPES.DELETE_LOADOUT(position)};minimalLoadout=createMinimalLoadout(loadoutData,unlockedCannons,requestSave,!0);const options=minimalLoadout.querySelector(".loadout-options");minimalLoadout.querySelector(".loadout-name")?.addEventListener("input",requestSave);const rightOptionWrapper=document.createElement("div");rightOptionWrapper.classList.add("loadout-options-right");const deleteOption=document.createElement("button");deleteOption.type="button",deleteOption.classList.add("delete-loadout"),deleteOption.classList.add("inactive"),deleteOption.textContent="Delete Loadout",deleteOption.onclick=()=>{minimalLoadout.classList.contains("save")&&REQUEST_TYPES.DELETE_LOADOUT(Array.prototype.indexOf.call(document.querySelectorAll(".loadout-wrapper"),minimalLoadout)),minimalLoadout.remove()};const shareOption=document.createElement("button");return shareOption.type="button",shareOption.classList.add("share-loadout-link"),shareOption.textContent="Copy Share Code",shareOption.onclick=async()=>{const tableUnits=createLoadoutObject(minimalLoadout);tableUnits.units.length>0?encodeLink(tableUnits,await REQUEST_TYPES.GET_MULTIPLE_DATA(tableUnits.units,!0)).then(link=>{navigator.clipboard.writeText(link),REQUEST_TYPES.SEND_ALERT("Loadout data copied to clipboard!",!1)}):REQUEST_TYPES.SEND_ALERT("Loadout has no units!",!0)},rightOptionWrapper.append(deleteOption,shareOption),options?.appendChild(rightOptionWrapper),minimalLoadout}function createLoadoutObject(container){return{title:container.querySelector(".loadout-name").value.trim(),units:[...container.querySelectorAll(".chip.set-unit")].map(c=>parseInt(c.dataset.id??"0")),forms:[...container.querySelectorAll(".chip.set-unit")].map(c=>parseInt(c.dataset.form??"0")),baseLevels:[parseInt(container.querySelector(".base-cannon").dataset.type??"0"),parseInt(container.querySelector(".base-style").dataset.type??"0"),parseInt(container.querySelector(".base-foundation").dataset.type??"0")]}}document.addEventListener("DOMContentLoaded",()=>{initializeContent(),window.addEventListener("portLoaded",loadLoadouts),checkPort()&&window.dispatchEvent(new CustomEvent("portLoaded"))});