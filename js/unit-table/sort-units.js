import*as sortOrderModule from"../../assets/unit_data/sort_order.js";const ORB_ORDER=["none","D","C","B","A","S"],RARITY_ORDER=["N","EX","RR","SR","UR","LR"],SORT_ORDER=sortOrderModule.default,SORT_SETTING_ORDER=[gameSortLambda,idSortLambda,nameSortLambda,formSortLambda,levelSortLambda,talentSortLambda,orbSortLambda,favoriteSortLambda];export default function attachUnitTableColumnSort(table){const thead=table.querySelector("thead"),sortID=thead.querySelector(".sort-id"),sortForm=thead.querySelector(".sort-form"),sortName=thead.querySelector(".sort-name"),sortLevel=thead.querySelector(".sort-level"),sortTalent=thead.querySelector(".sort-talent"),sortOrb=thead.querySelector(".sort-orb"),sortFavorite=thead.querySelector(".sort-favorite"),allSort=[sortID,sortForm,sortName,sortLevel,sortTalent,sortOrb,sortFavorite],data=table.querySelector("tbody");attachSort(sortID,idSortLambda,allSort,data),attachSort(sortForm,formSortLambda,allSort,data),attachSort(sortName,nameSortLambda,allSort,data),attachSort(sortLevel,levelSortLambda,allSort,data),attachSort(sortTalent,talentSortLambda,allSort,data),attachSort(sortOrb,orbSortLambda,allSort,data),attachSort(sortFavorite,favoriteSortLambda,allSort,data),assignRowSortData(data.querySelectorAll("tr")),sortRows(data,SORT_SETTING_ORDER[parseInt(window.localStorage.getItem("skey")??"0")],"Y"===window.localStorage.getItem("sasc"))}function attachSort(sortTarget,sort,allSort,tbody){sortTarget.onclick=()=>{sortTarget.classList.contains("ascending")?(sortRows(tbody,sort,!1),allSort.forEach(s=>{s.classList.remove("descending"),s.classList.remove("ascending")}),sortTarget.classList.add("descending")):(sortRows(tbody,sort,!0),allSort.forEach(s=>{s.classList.remove("descending"),s.classList.remove("ascending")}),sortTarget.classList.add("ascending"))}}export function sortRows(tbody,comparator,isAscending){const rowPairs=[...tbody.rows].reduce((prev,next)=>(next.classList.contains("unit-mod-row")?prev.push([next]):next.classList.contains("stat-mod-row")&&prev[prev.length-1].push(next),prev),[]);rowPairs.sort((a,b)=>comparator(a[0],b[0]));const fragment=document.createDocumentFragment();let flipBG=0;const visualUpdate=tbody.classList.contains("legend-rare-multi")?i=>{for(let x=1;x<=8;x++)rowPairs[i][0].classList.remove(`legend-row-${x}`);rowPairs[i][0].classList.add(`legend-row-${flipBG+1}`),flipBG=(flipBG+1)%8}:i=>{rowPairs[i][0].classList.toggle("row-bg2",1===flipBG),flipBG=1-flipBG};if(isAscending)for(let i=0;i<rowPairs.length;i++)visualUpdate(i),fragment.append(...rowPairs[i]);else for(let i=rowPairs.length-1;i>=0;i--)visualUpdate(i),fragment.append(...rowPairs[i]);tbody.appendChild(fragment)}export function idSortLambda(a,b){return parseInt(a.querySelector("td.row-id").innerText)-parseInt(b.querySelector("td.row-id").innerText)}export function formSortLambda(a,b){const res=parseInt(b.querySelector("td.row-name").dataset.form??"0")-parseInt(a.querySelector("td.row-name").dataset.form??"0");return 0!==res?res:idSortLambda(a,b)}export function nameSortLambda(a,b){return a.querySelector("td.row-name").innerText<b.querySelector("td.row-name").innerText?-1:1}export function levelSortLambda(a,b){const aCell=a.querySelector("td.row-level"),bCell=b.querySelector("td.row-level"),maxLevelA=aCell.querySelector(".max-level"),maxLevelB=bCell.querySelector(".max-level"),res1=parseInt(maxLevelB?.value??"1")-parseInt(maxLevelA?.value??"1");if(0!==res1)return res1;const maxPlusLevelA=aCell.querySelector(".max-plus-level"),maxPlusLevelB=bCell.querySelector(".max-plus-level"),res2=parseInt(maxPlusLevelB?.value??"0")-parseInt(maxPlusLevelA?.value??"0");return 0!==res2?res2:idSortLambda(a,b)}export function talentSortLambda(a,b){const aCell=a.querySelector("td.row-talent"),bCell=b.querySelector("td.row-talent"),cappedCount=bCell.querySelectorAll(".maxed-talent").length-aCell.querySelectorAll(".maxed-talent").length;if(0!==cappedCount)return cappedCount;const talentSum=[...bCell.querySelectorAll(".talent-box p")].reduce((sum,v)=>sum+parseInt(v.textContent??"0"),0)-[...aCell.querySelectorAll(".talent-box p")].reduce((sum,v)=>sum+parseInt(v.textContent??"0"),0);if(0!==talentSum)return talentSum;const talentCount=bCell.querySelectorAll(".talent-box").length-aCell.querySelectorAll(".talent-box").length;return 0!==talentCount?talentCount:idSortLambda(a,b)}export function orbSortLambda(a,b){const aCell=a.querySelector("td.row-orb"),bCell=b.querySelector("td.row-orb"),ranksA=[...aCell.querySelectorAll(".orb-selector .orb-rank")].map(v=>ORB_ORDER.indexOf(v.dataset.rank??""),0).sort(),ranksB=[...bCell.querySelectorAll(".orb-selector .orb-rank")].map(v=>ORB_ORDER.indexOf(v.dataset.rank??""),0).sort();for(;ranksA.length>0&&ranksB.length>0;){const rankAMax=ranksA.pop(),rankBMax=ranksB.pop();if(rankBMax-rankAMax!==0)return rankBMax-rankAMax}if(ranksB.length-ranksA.length!==0)return ranksB.length-ranksA.length;const orbSlotCount=bCell.querySelectorAll(".orb-selector").length-aCell.querySelectorAll(".orb-selector").length;return 0!==orbSlotCount?orbSlotCount:idSortLambda(a,b)}export function favoriteSortLambda(a,b){const res=parseInt(b.querySelector("td.row-favorite div").dataset.favorited??"N")-parseInt(a.querySelector("td.row-favorite div").dataset.favorited??"N");return 0!==res?res:idSortLambda(a,b)}export function gameSortLambda(a,b){if(a.dataset.rarity!==b.dataset.rarity)return RARITY_ORDER.indexOf(a.dataset.rarity??"")-RARITY_ORDER.indexOf(b.dataset.rarity??"");const aMajor=parseInt(a.dataset.major_order??"-1"),aMinor=parseInt(a.dataset.minor_order??"-1"),bMajor=parseInt(b.dataset.major_order??"-1"),bMinor=parseInt(b.dataset.minor_order??"-1");return-1===aMajor||-1===aMinor?-1===bMajor||-1===bMinor?idSortLambda(a,b):-1:-1===bMajor||-1===bMinor?1:aMajor===bMajor?aMinor-bMinor:aMajor-bMajor}function assignRowSortData(rows){rows.forEach(r=>{const id=parseInt(r.querySelector("td.row-id")?.textContent??"0");for(const[name,arr]of Object.entries(SORT_ORDER[r.dataset.rarity].categories))for(let x=0;x<arr.length;x++)if(arr[x]===id)return r.dataset.major_order=`${SORT_ORDER[r.dataset.rarity].main.indexOf(name)}`,void(r.dataset.minor_order=`${x}`);r.dataset.major_order="-1",r.dataset.minor_order="-1",console.error(`Unable to find id ${id} in sort_order.js!`)})}