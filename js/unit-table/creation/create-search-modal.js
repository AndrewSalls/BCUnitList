import SETTINGS from"../../../assets/settings.js";import{REQUEST_TYPES}from"../../communication/iframe-link.js";import*as FilterInput from"./create-search-modal-filter.js";let unitSelectCallback=null;export function openSearchModal(unitCallback,ownedOnly=null){unitSelectCallback=unitCallback;const actualOwnedCheckbox=document.querySelector("#advanced-owned-wrapper input");actualOwnedCheckbox.disabled=null!==ownedOnly,null!==ownedOnly&&(actualOwnedCheckbox.checked=ownedOnly,actualOwnedCheckbox.parentElement?.classList.add("hidden"));document.querySelector("#advanced-results-content").innerHTML="",document.querySelector("#advanced-search-modal-wrapper")?.classList.remove("hidden")}const rarityMap={N:"Normal",EX:"Special",RR:"Rare",SR:"Super Rare",UR:"Uber Rare",LR:"Legend Rare"};export default function createSearchModal(){const output=document.createElement("div");output.classList.add("hidden"),output.id="advanced-search-modal-wrapper";const closeX=document.createElementNS("http://www.w3.org/2000/svg","svg");closeX.id="advanced-search-exit",closeX.setAttribute("viewBox","0 0 64 64"),closeX.innerHTML='<polygon points="10,0 0,10 54,64 64,54" /><polygon points="54,0 64,10 10,64 0,54" />',closeX.onclick=()=>output.classList.add("hidden"),output.appendChild(closeX);const content=document.createElement("div");content.id="advanced-search-modal";const searchOptions=document.createElement("div");searchOptions.id="advanced-search-options";const optionLabel=document.createElement("h2");optionLabel.id="advanced-search-label",optionLabel.textContent="Advanced Search";const{obj:nameInput,filterCallback:filterName}=FilterInput.createNameFilterInput(),{obj:ownedCheckbox,filterCallback:filterOwnedOnly}=FilterInput.createOwnedFilterInput(),{obj:raritySelection,filterCallback:filterRarity}=FilterInput.createRarityFilterInput(),{obj:traitSelection,filterCallback:filterTargetTraits}=FilterInput.createTargetTraitFilterInput(),{obj:abilityMultibox,filterCallback:filterAbilities}=FilterInput.createAbilityFilterInput(),actualOwnedCheckbox=ownedCheckbox.querySelector("input"),{obj:statMultiRange,filterCallback:filterStatRange}=FilterInput.createStatFilterInput(actualOwnedCheckbox),{obj:randomToggle,filterCallback:filterRandom10}=FilterInput.createRandom10FilterInput(),searchButton=document.createElement("button");searchButton.id="advanced-search-enter",searchButton.innerHTML='\n    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">\n        <path d="M10 2a8 8 0 105.29 14.29l5.21 5.21 1.5-1.5-5.21-5.21A8 8 0 0010 2zm0 2a6 6 0 110 12 6 6 0 010-12z"/>\n    </svg>',searchButton.onclick=()=>applySearch(u=>{const datalist=document.querySelector("#search-suggestion-dropdown");let nullCount=0;const units=[...new Array(u.max_form+1).keys()].map(i=>{const unitOutput=[!1,!1,!1];let sharedFilter=filterOwnedOnly(u)&&filterRarity(u)&&filterName(u).includes(i);const targetSearchField=datalist.querySelector(`div[data-target='${u.id}'][data-form='${i}']`);sharedFilter=sharedFilter&&null!==targetSearchField&&!targetSearchField.classList.contains("global-hidden");const formTraits=filterTargetTraits(u),formAbilities=filterAbilities(u),formStats=filterStatRange(u);return unitOutput[0]=sharedFilter&&formTraits[i][0]&&formAbilities[i][0]&&formStats[i][0],unitOutput[1]=!actualOwnedCheckbox.checked&&sharedFilter&&formTraits[i][1]&&formAbilities[i][1]&&formStats[i][1],unitOutput[2]=!actualOwnedCheckbox.checked&&sharedFilter&&formTraits[i][2]&&formAbilities[i][2]&&formStats[i][2],unitOutput[0]||unitOutput[1]||unitOutput[2]?unitOutput:(nullCount++,null)});return nullCount===units.length?null:units},filterRandom10);const searchButtonText=document.createElement("p");searchButtonText.textContent="Search",searchButton.prepend(searchButtonText);const nameSearchAlign=document.createElement("div");nameSearchAlign.id="advanced-search-name-align",nameSearchAlign.append(nameInput,ownedCheckbox,searchButton);const otherWrapper=document.createElement("div");otherWrapper.classList.add("advanced-wrapper");const wrapperLabel=document.createElement("h4");wrapperLabel.textContent="Other";const wrapperContents=document.createElement("div");wrapperContents.id="advanced-other-spacer",wrapperContents.appendChild(randomToggle),otherWrapper.append(wrapperLabel,wrapperContents);const resetButton=document.createElement("button");resetButton.onclick=resetAllFilters,resetButton.textContent="Reset Filters",searchOptions.append(optionLabel,nameSearchAlign,resetButton,raritySelection,traitSelection,abilityMultibox,statMultiRange,otherWrapper);const results=createResults();return content.append(searchOptions,results),output.appendChild(content),output}async function applySearch(searchCallback,resultFilter){const data=await REQUEST_TYPES.GET_ALL_DATA(!0),res={};for(const u of data){const forms=searchCallback(u);forms&&(res[u.id]={forms:forms,data:u})}const resFilter=resultFilter(Object.keys(res).map(k=>parseInt(k)));displayResults(Object.fromEntries(resFilter.map(k=>[k,res[k]])))}function createResults(){const results=document.createElement("div");results.id="advanced-search-results";const resultLabel=document.createElement("h3");resultLabel.id="advanced-results-label",resultLabel.textContent="Results";const input=document.createElement("input");input.id="advanced-result-minify",input.type="checkbox",input.checked=!1,input.onchange=()=>resultsContent.classList.toggle("advanced-simple-result",input.checked);const label=document.createElement("label");label.textContent="Simple Results",label.title="Search results will only show the unit icon",label.htmlFor="advanced-result-minify";const resultMinInfoWrapper=document.createElement("div");resultMinInfoWrapper.classList.add("advaced-label-spacer"),resultMinInfoWrapper.append(label,input);const resultsContent=document.createElement("div");return resultsContent.id="advanced-results-content",results.append(resultLabel,resultMinInfoWrapper,resultsContent),results}function displayResults(results){const container=document.querySelector("#advanced-results-content");container.innerHTML="";for(const key of Object.keys(results).sort((a,b)=>parseInt(a)-parseInt(b))){const result=document.createElement("div");result.classList.add(`${rarityMap[results[key].data.rarity].toLowerCase().replaceAll(" ","-")}-color`),result.classList.add("advanced-result-wrapper");const iconWrapper=document.createElement("div");iconWrapper.classList.add("advanced-icon-centering");const icon=document.createElement("img"),maxValidForm=results[key].forms.findLastIndex(x=>null!==x),validImage=SETTINGS.skipImages.includes(parseInt(key));icon.src=validImage?"./assets/img/unit_icon/unknown.png":`./assets/img/unit_icon/${key}_${maxValidForm}.png`,icon.title=[results[key].data.normal_form,results[key].data.evolved_form,results[key].data.true_form,results[key].data.ultra_form][maxValidForm],icon.dataset.form=`${maxValidForm}`,iconWrapper.appendChild(icon),icon.onclick=()=>{document.querySelector("#advanced-search-modal-wrapper")?.classList.add("hidden"),unitSelectCallback(results[key].data,parseInt(icon.dataset.form??"0"))};const id=document.createElement("p");id.classList.add("advanced-result-id"),id.textContent=key;const hAlign=document.createElement("div");hAlign.classList.add("advanced-result-details");const talentReq=document.createElement("div");talentReq.classList.add("advanced-talent-required"),talentReq.title="Whether the unit needs talents unlocked to meet the search criteria";const npImg=document.createElement("img");npImg.classList.add("advanced-np-img"),npImg.src="./assets/img/evo_mats/np_token.png",talentReq.appendChild(npImg);const utReq=document.createElement("div");utReq.classList.add("advanced-ut-required"),utReq.title="Whether the unit needs ultra talents unlocked to meet the search criteria";const npImg2=document.createElement("img");npImg2.classList.add("advanced-np-img"),npImg2.src="./assets/img/evo_mats/np_token.png";const darkImg=document.createElement("img");darkImg.classList.add("advanced-dark-img"),darkImg.src="./assets/img/evo_mats/dark_catseye.png",talentReq.classList.toggle("advanced-resource",!(!results[key].forms[maxValidForm][0]&&results[key].forms[maxValidForm][1])),utReq.classList.toggle("advanced-resource",!(!results[key].forms[maxValidForm][0]&&!results[key].forms[maxValidForm][1])),utReq.append(darkImg,npImg2),hAlign.append(talentReq,utReq);for(let x=0;x<4;x++){const formBtn=document.createElement("div");formBtn.classList.add("advanced-form-option"),formBtn.classList.add(`advanced-form-${x}`),results[key].forms[x]&&(formBtn.innerHTML=["N","E","T","U"][x],formBtn.classList.add("advanced-clickable"),formBtn.onclick=()=>{icon.src=validImage?"./assets/img/unit_icon/unknown.png":`./assets/img/unit_icon/${key}_${x}.png`,icon.title=[results[key].data.normal_form,results[key].data.evolved_form,results[key].data.true_form,results[key].data.ultra_form][x],icon.dataset.form=`${x}`,talentReq.classList.toggle("advanced-resource",!(!results[key].forms[x][0]&&results[key].forms[x][1])),utReq.classList.toggle("advanced-resource",!(!results[key].forms[x][0]&&!results[key].forms[x][1]))}),hAlign.appendChild(formBtn)}result.append(id,iconWrapper,hAlign),container.appendChild(result)}}function resetAllFilters(){document.querySelectorAll("#advanced-rarity-spacer .advanced-rarity-selector").forEach(i=>i.classList.add("inactive")),document.querySelectorAll("#advanced-trait-spacer .advanced-trait-selector-wrapper").forEach(i=>i.classList.add("inactive")),document.querySelectorAll("#advanced-ability-spacer .advanced-ability-selector").forEach(i=>i.classList.add("inactive")),document.querySelectorAll("#advanced-stats-spacer input[type='text']").forEach(i=>i.value=""),document.querySelector("#advanced-level-box .advanced-level-option[data-level-type='0']").click(),document.querySelector("#advanced-results-content").innerHTML=""}