import createArrowNumberBox from"./cat-base/arrow-box.js";import{createSearchDropdown,initializeDataset}from"./helper/make-searchable.js";import{decodeLink,encodeDirectLink}from"./helper/encoder.js";import{createMinimalLoadout}from"./unit-table/creation/create-loadout-table.js";import createRow from"./unit-table/creation/create-unit-row.js";import createSearchableTable from"./unit-table/creation/create-unit-table.js";import createOrbMenu from"./unit-table/orb/create-orb-selector.js";import{initializeOrbSelection}from"./unit-table/orb/orb-selection.js";import{getValuesFromRow}from"./helper/link-row.js";import{checkPort,REQUEST_TYPES}from"./communication/iframe-link.js";import SETTINGS from"../assets/settings.js";import createSearchModal from"./unit-table/creation/create-search-modal.js";let idFormMap=new Map;function initializeContent(){document.body.appendChild(createOrbMenu()),initializeOrbSelection(),document.body.appendChild(createSearchModal());const table=createSearchableTable("Loadout",[]);table.querySelector(".searchable-table-title")?.parentElement?.remove(),table.querySelector("thead tr.hidden")?.classList.remove("hidden"),table.querySelector("tbody.hidden")?.classList.remove("hidden"),document.querySelector("#unit-data-box")?.appendChild(table);const clearButton=document.querySelector("#reset-loadout");clearButton.onclick=()=>{idFormMap.clear(),document.querySelector("#unit-data-box tbody")?.replaceChildren(),document.querySelectorAll("#loadout-box .chip.set-unit").forEach(c=>{c.classList.remove("set-unit"),delete c.dataset.form,delete c.dataset.maxForm,delete c.dataset.id,c.querySelector(".unit-icon").src="./assets/img/unit_icon/unknown.png",c.querySelector(".remove-unit")?.classList.add("hidden"),c.querySelector(".unset-search-wrapper")?.classList.remove("hidden")}),document.querySelector("#loadout-cannon input").value="1",document.querySelector("#loadout-style input").value="0",document.querySelector("#loadout-foundation input").value="0"};const codeEnterButton=document.querySelector("#import-loadout"),shareCodeInput=document.querySelector("#code-input");shareCodeInput?.addEventListener("keyup",ev=>{"Enter"===ev.key&&codeEnterButton.click()}),codeEnterButton.onclick=()=>{const loadoutCode=shareCodeInput.value;shareCodeInput.value="";try{const decoded=decodeLink(loadoutCode);clearButton.click(),document.querySelector("#loadout-box .loadout-name").value=decoded.title,document.querySelector("#loadout-cannon input").value=`${decoded.baseLevels[0]}`,document.querySelector("#loadout-style input").value=`${decoded.baseLevels[1]}`,document.querySelector("#loadout-foundation input").value=`${decoded.baseLevels[2]}`;const cannon=document.querySelector("#loadout-box .base-cannon");cannon.dataset.type=`${decoded.baseLevels[0]}`,cannon.src=`./assets/img/foundation/base_${decoded.baseLevels[0]}.png`;const style=document.querySelector("#loadout-box .base-style");style.dataset.type=`${decoded.baseLevels[1]}`,style.src=`./assets/img/foundation/base_${decoded.baseLevels[1]}_style.png`;const foundation=document.querySelector("#loadout-box .base-foundation");foundation.dataset.type=`${decoded.baseLevels[2]}`,foundation.src=`./assets/img/foundation/base_${decoded.baseLevels[2]}_foundation.png`;const chips=[...document.querySelectorAll("#loadout-box .chip")];for(let x=0;x<decoded.units.length&&x<chips.length;x++)REQUEST_TYPES.GET_ID_DATA(decoded.units[x].id,!0).then(u=>{if(!u)return void console.error(`Missing unit data: ${decoded.units[x].id}`);chips[x].classList.add("set-unit"),chips[x].querySelector(".unit-icon").src=`./assets/img/unit_icon/${decoded.units[x].id}_${decoded.forms[x]}.png`,chips[x].dataset.form=`${decoded.forms[x]}`,chips[x].dataset.id=`${decoded.units[x].id}`,chips[x].dataset.maxForm=`${u.max_form}`,chips[x].querySelector(".remove-unit")?.classList.remove("hidden"),chips[x].querySelector(".unset-search-wrapper")?.classList.add("hidden"),u.current_form=decoded.forms[x],u.level=decoded.units[x].level,u.plus_level=decoded.units[x].plus_level;for(let y=0;y<u.talents.length;y++)u.talents[y].value=decoded.units[x].talents[y]??0;for(let y=0;y<u.ultra_talents.length;y++)u.ultra_talents[y].value=decoded.units[x].ultra_talents[y]??0;for(let y=0;y<u.orb.length;y++)u.orb[y]=decoded.units[x].orb[y]??null;const newRow=createRow(u);newRow.querySelector(".hide-option")?.remove(),newRow.querySelector(".unit-icon")?.addEventListener("click",()=>{const form=parseInt(newRow.querySelector(".row-image").dataset.form??"0"),chip=document.querySelector(`#loadout-box .chip[data-id='${decoded.units[x].id}']`);chip.dataset.form=`${form}`,chip.querySelector(".unit-icon").src=`./assets/img/unit_icon/${decoded.units[x].id}_${form}.png`,idFormMap.set(decoded.units[x].id,form)}),document.querySelector("#unit-data-box tbody")?.appendChild(newRow),idFormMap.set(decoded.units[x].id,decoded.forms[x])})}catch(e){console.error(e),REQUEST_TYPES.SEND_ALERT("Invalid loadout data!",!0)}};const container=document.querySelector("#loadout-box");document.querySelector("#copy-loadout").onclick=async()=>{const unitRows=[...document.querySelectorAll("#unit-data-box tbody tr")],output={title:container.querySelector(".loadout-name").value.trim(),forms:[...container.querySelectorAll(".chip.set-unit")].map(c=>parseInt(c.dataset.form??"0")),units:[],baseLevels:[0,0,0]};output.baseLevels[0]=parseInt(document.querySelector("#loadout-cannon input").value),output.baseLevels[1]=parseInt(document.querySelector("#loadout-style input").value),output.baseLevels[2]=parseInt(document.querySelector("#loadout-foundation input").value);const unitData=unitRows.map(r=>getValuesFromRow(r));if(unitData.forEach((d,i)=>d.current_form=output.forms[i]),output.units=unitData,output.units.length>0){const link=encodeDirectLink(output);navigator.clipboard.writeText(link),REQUEST_TYPES.SEND_ALERT("Loadout data copied to clipboard!",!1)}else REQUEST_TYPES.SEND_ALERT("Loadout has no units!",!0)}}function createBaseLevelInput(value,cap,type){const valueLabel=document.createElement("label");valueLabel.classList.add("h-align"),valueLabel.dataset.inputType=`${type}`;const labelText=document.createElement("p");switch(type){case 0:labelText.textContent="Cannon Level:";break;case 1:labelText.textContent="Style Level:";break;case 2:labelText.textContent="Foundation Level:";break;default:labelText.textContent="Undefined part of base"}const[labelInput,_inputElm]=createArrowNumberBox(cap,value,()=>{});return valueLabel.append(labelText,labelInput),valueLabel}async function loadLoadouts(){const baseLeveling=document.querySelector("#base-box"),cannon=createBaseLevelInput(1,SETTINGS.ototo.cannon,0);cannon.id="loadout-cannon";const style=createBaseLevelInput(0,SETTINGS.ototo.style,1);style.id="loadout-style";const foundation=createBaseLevelInput(0,SETTINGS.ototo.base,2);foundation.id="loadout-foundation",baseLeveling?.append(cannon,style,foundation);const unlockedCannons=[];for(let x=0;x<SETTINGS.ototo.names.length;x++)unlockedCannons[x]={cannon:!0,style:!0,foundation:!0};const datalist=createSearchDropdown();document.body.appendChild(datalist),initializeDataset(datalist,await REQUEST_TYPES.GET_NAMES(!0));const emptyLoadout=createMinimalLoadout(null,unlockedCannons,syncLoadoutAndTable,null);document.querySelector("#loadout-box")?.appendChild(emptyLoadout)}function syncLoadoutAndTable(){const loadoutUnits=[...document.querySelectorAll("#loadout-box .chip.set-unit")].map(c=>({id:parseInt(c.dataset.id??"0"),form:parseInt(c.dataset.form??"0")}));if(loadoutUnits.length<idFormMap.size)for(const unit of idFormMap.keys())loadoutUnits.find(u=>u.id===unit)||(idFormMap.delete(unit),[...document.querySelectorAll("#unit-data-box .row-id")].find(r=>r.textContent===`${unit}`)?.parentElement?.remove());else if(loadoutUnits.length>idFormMap.size)for(const unit of loadoutUnits)idFormMap.has(unit.id)||(idFormMap.set(unit.id,unit.form),REQUEST_TYPES.GET_ID_DATA(unit.id,!0).then(u=>{if(!u)return void console.error(`Missing unit data: ${unit.id}`);u.current_form=unit.form;const newRow=createRow(u);newRow.querySelector(".hide-option")?.remove(),newRow.querySelector(".unit-icon")?.addEventListener("click",()=>{const form=parseInt(newRow.querySelector(".row-image").dataset.form??"0"),chip=document.querySelector(`#loadout-box .chip[data-id='${unit.id}']`);chip.dataset.form=`${form}`,chip.querySelector(".unit-icon").src=`./assets/img/unit_icon/${unit.id}_${form}.png`,idFormMap.set(unit.id,form)}),document.querySelector("#unit-data-box tbody")?.appendChild(newRow)}));else for(const unit of loadoutUnits)if(idFormMap.get(unit.id)!==unit.form){const targetID=[...document.querySelectorAll("#unit-data-box .row-id")].find(r=>r.textContent===`${unit.id}`),targetRowIcon=targetID?.parentElement?.querySelector(".row-image"),targetRowImage=targetRowIcon.querySelector(".unit-icon"),start=parseInt(targetRowIcon.dataset.form??"0");do{targetRowImage.click()}while(parseInt(targetRowIcon.dataset.form??"0")!==unit.form&&parseInt(targetRowIcon.dataset.form??"0")!==start);idFormMap.set(unit.id,parseInt(targetRowIcon.dataset.form??"0"))}}document.addEventListener("DOMContentLoaded",()=>{initializeContent(),window.addEventListener("portLoaded",loadLoadouts),checkPort()&&window.dispatchEvent(new CustomEvent("portLoaded"))});